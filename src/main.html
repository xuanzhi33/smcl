<!DOCTYPE html>
<!--Made with ❤ by XUANZHI-->
<!--该页面已接入百度统计-->
<html>

<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#e9f1e9">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SMCL</title>
  <!-- Bootstrap -->
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <link href="./css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
</head>

<body>
  <div id="app"></div>
  <template id="main">
    <transition mode="out-in">
      <loading v-if="ui === 'loading'" :title="loadingTitle" :handle-cmd-result="handleCmdResult"
        :log-placeholder="logPlaceholder"></loading>
      <warning v-else-if="ui === 'warning'" :title="warningTitle" @close="goBack">
        {{ warningContent }}
      </warning>
      <settings v-else-if="ui === 'settings'" :afl="actionAfterLaunch" :ds="downloadSource"
        @update="updateSettings" @close="goBack"></settings>
      <div v-else-if="ui === 'main'">
        <button class="ctrl button account-menu">
          <div style="font-size: 1.2rem; font-weight: bold;">
            {{ curPlayer || $t('notLogin') }}
            <i class="fa fa-edit"></i>
          </div>
          <div class="text-muted">
            <div v-if="!curPlayer">
              <i class="fa fa-user-plus"></i>
              {{ $t('clickToAddAccount') }}
            </div>
            <div v-else-if="accountType === 2">
              <i class="fa fa-windows"></i>
              {{ $t('microsoftAccount') }}
            </div>
            <div v-else>
              <i class="fa fa-user-circle-o"></i>
              {{ $t('offlineAccount') }}
            </div>
          </div>
        </button>
      </div>
    </transition>

    <transition>
      <div class="main-menu" v-if="ui === 'main'">
        <button class="ctrl button">
          <i class="fa fa-bars"></i>
          {{ $t('versionList') }}
        </button> &nbsp;
        <button class="ctrl button" @click="changeUI('settings')">
          <i class="fa fa-cog"></i>
          {{ $t('settings') }}
        </button>
      </div>
    </transition>
    <transition>
      <div class="start-btns" v-if="ui === 'main'">
        <button class="ctrl button btn-block" @click="launchGame" :disabled="ui !== 'main' || running">
          <span class="text-success" v-if="running">
            <i class="fa fa-gamepad"></i>
            {{ $t('running') }}
          </span>
          <span v-else class="font-weight-bold">
            <i class="fa fa-play-circle"></i>
            {{ $t('launchBtn') }}
          </span>
          <br>
          <span class="text-muted">
            {{ curVer || $t('selectVer') }}
          </span>

        </button>
      </div>
    </transition>
  </template>

  <template id="ui-container">
    <div class="container my-5">
      <div class="ctrl text-center">
        <span class="title">
          <slot name="title"></slot>
        </span>
        <div class="mt-3">
          <slot name="content"></slot>
        </div>
      </div>
    </div>
  </template>

  <template id="loading">
    <ui-container>
      <template #title>
        {{ title }}
      </template>
      <template #content>
        <div class="mb-3">
          <span class="spinner-border spinner-border-sm"></span>
          {{ log }}
        </div>
        <div class="progress">
          <div class="progress-bar bg-success" :style="{ width: progress + '%' }"></div>
        </div>
      </template>
    </ui-container>
  </template>

  <template id="warning">
    <ui-container>
      <template #title>
        <span class="text-danger">
          <i class="fa fa-warning"></i>
        </span>
        {{ title }}
      </template>
      <template #content>
        <slot></slot>
        <button class="btn btn-success btn-block mt-3" @click="$emit('close')">
          <i class="fa fa-check"></i> {{ $t('ok') }}
        </button>
      </template>
    </ui-container>
  </template>

  <template id="settings">
    <ui-container>
      <template #title>
        <i class="fa fa-cog"></i>
        {{ $t('settings') }}
      </template>
      <template #content>
        <div class="font-weight-bold">{{ $t('language') }}</div>
        <input type="radio" name="language" value="en" id="en" v-model="language"> <label for="en">English</label> &nbsp;
        <input type="radio" name="language" value="zh" id="zh" v-model="language"> <label for="zh">中文</label>
        
        <div class="font-weight-bold">{{ $t('actionAfterLaunch') }}</div>
        <input type="radio" name="actionAfterLaunch" value="minimize" id="minimize" v-model="actionAfterLaunch"> <label
          for="minimize">{{ $t('minimize') }}</label> &nbsp;
        <input type="radio" name="actionAfterLaunch" value="close" id="close" v-model="actionAfterLaunch"> <label
          for="close">{{ $t('close') }}</label> &nbsp;
        <input type="radio" name="actionAfterLaunch" value="none" id="none" v-model="actionAfterLaunch"> <label
          for="none">{{ $t('none') }}</label>

        <div class="font-weight-bold">{{ $t('downloadSource') }}</div>
        <input type="radio" name="downloadSource" value="0" id="official" v-model="downloadSource"> <label
          for="official">{{ $t('official') }}</label> &nbsp;
        <input type="radio" name="downloadSource" value="1" id="bmcl" v-model="downloadSource"> <label for="bmcl">{{ $t('bmcl') }}</label>

        <button class="btn btn-success btn-block mt-3" @click="$emit('close')">
          <i class="fa fa-check"></i> {{ $t('finish') }}
        </button>
      </template>
  </template>

  <!-- TODO: Component templates -->

  <script src="./vue.global.prod.js"></script>
  <script src="./vue-i18n.global.prod.js"></script>
  <script type="module">
    const VERSION = "1.0.0";
    const { createApp } = Vue;
    const { createI18n } = VueI18n;
    let api = null;

    const i18n = createI18n({
      locale: "zh",
      messages: {
        en: {
          launchBtn: "Launch Game",
          selectVer: "Select Version",
          versionUnselected: "Version Unselected",
          launching: "Launching...",
          loggingIn: "Logging in as '{name}'",
          notLogin: "Not logged in",
          player: "Player",
          launchFail: "Failed to launch game",
          running: "Running",
          ok: "OK",
          versionList: "Version List",
          settings: "Settings",
          microsoftAccount: "Microsoft Account",
          offlineAccount: "Offline Account",
          clickToAddAccount: "Click to add account"

          // TODO: i18n en
        },
        zh: {
          launchBtn: "启动游戏",
          selectVer: "选择版本",
          versionUnselected: "未选择游戏版本",
          launching: "启动中...",
          loggingIn: "正在以 “{name}” 的身份登录",
          notLogin: "未登录",
          player: "玩家",
          launchFail: "游戏启动失败",
          running: "运行中",
          ok: "好的",
          versionList: "版本列表",
          settings: "设置",
          microsoftAccount: "微软账户",
          offlineAccount: "离线账户",
          clickToAddAccount: "点击添加账户"
          // TODO: i18n zh
        }
      }
    });

    const UiContainer = {
      template: "#ui-container"
    };

    const Warning = {
      components: {
        UiContainer
      },
      emits: ["close"],
      template: "#warning",
      props: {
        title: {
          type: String
        }
      }
    };

    // TODO: Loading
    const Loading = {
      components: {
        UiContainer
      },
      template: "#loading",
      props: {
        title: {
          type: String
        },
        handleCmdResult: {
          type: Function
        },
        logPlaceholder: {
          type: String,
          default: " "
        }
      },
      data() {
        return {
          progress: 0,
          log: ""
        };
      },
      methods: {
        cmdResult(result) {
          this.handleCmdResult(result, this);
        }
      },
      mounted() {
        window.cmdResult = this.cmdResult;
        this.log = this.logPlaceholder;
      }
    };

    // TODO: Settings
    const Settings = {
      components: {
        UiContainer
      },
      props: {
        afl: {
          type: String
        },
        ds: {
          type: Number
        }
      },
      data() {
        return {
          language: this.$i18n.locale,
          actionAfterLaunch: this.afl,
          downloadSource: this.ds
        };
      },
      template: "#settings",
      watch: {
        language(val) {
          this.$emit("update", "language", val);
        },
        actionAfterLaunch(val) {
          this.$emit("update", "smclActionAfterLaunch", val);
        },
        downloadSource(val) {
          this.$emit("update", "downloadSource", parseInt(val));
        }
      },
      i18n: {
        messages: {
          en: {
            language: "Language / 语言",
            finish: "Finish",
            actionAfterLaunch: "Action after launch",
            minimize: "Minimize",
            close: "Quit",
            none: "None",
            downloadSource: "Download source",
            official: "Official (Recommended)",
            bmcl: "BMCLAPI"
          },
          zh: {
            language: "语言 / Language",
            finish: "完成",
            actionAfterLaunch: "启动后操作",
            minimize: "最小化",
            close: "退出",
            none: "无",
            downloadSource: "下载源",
            official: "官方（推荐）",
            bmcl: "BMCLAPI"
          }
        }
      }
    };

    // TODO: Components
    const app = createApp({
      components: {
        Loading,
        Warning,
        Settings
      },
      data() {
        // TODO: data
        return {
          running: false,
          curVer: "",
          curPlayer: "",
          ui: "",
          loadingTitle: "",
          lastUI: "",
          accountType: 0,
          logPlaceholder: "",
          warningTitle: "",
          warningContent: "",
          handleCmdResult: null,
          actionAfterLaunch: null,
          downloadSource: 0
        };
      },
      methods: {
        // TODO: methods
        changeUI(ui) {
          this.lastUI = this.ui;
          this.ui = ui;
        },
        async updateSettings(key, value) {
          await api.config(key, value);
          await this.init();
        },
        init_api() {
          return new Promise(resolve => {
            window.addEventListener("pywebviewready", () => {
              api = pywebview.api;
              resolve();
            });
          });
        },
        startLoading(title, logPlaceholder, handleCmdResult) {
          this.changeUI("loading");
          this.loadingTitle = title;
          this.handleCmdResult = handleCmdResult;
          this.logPlaceholder = logPlaceholder;
        },
        finishLoading() {
          this.goBack();
          this.handleCmdResult = null;
        },
        showWarning(title, content) {
          this.changeUI("warning");
          this.warningTitle = title;
          this.warningContent = content;
        },
        goBack() {
          this.ui = this.lastUI;
        },
        async launchGame() {
          // TODO: launch game
          if (this.curVer === this.$t("selectVer")) {
            return;
          }
          await this.startLoading(this.$t("launchBtn"),
            this.$t("loggingIn", { name: this.curPlayer }),
            (result, loading) => {
              console.log(result);
              if (result.includes("Sound engine started")) {
                this.finishLoading();
                loading.progress = 100;
                this.running = true;
              } else if (result.includes("Setting user:")) {
                loading.log = this.$t("launching");
                loading.progress = 30;
              } else {
                loading.progress += 5;
              }
            });

          const res = await api.cmcl_waiting(null);
          this.running = false;
          if (res.includes("游戏崩溃可能的错误") || res.includes("Game crash possible error")) {
            this.finishLoading();
            // 正则匹配错误信息
            const reg = /^(游戏崩溃可能的错误：|Game crash possible error: ).*$/m;
            const match = reg.exec(res);
            this.showWarning(this.$t("launchFail"), match[0]);
          }
        },
        async init() {
          // TODO: init
          const config = await api.get_all_settings();
          this.$i18n.locale = config.language;
          this.curVer = config.selectedVersion;
          const players = config.accounts || [];
          for (const player of players) {
            if (player.selected) {
              this.curPlayer = player.playerName;
              this.accountType = player.loginMethod;
              break;
            }
          }
          const playerName = this.curPlayer || this.$t("notLogin");
          const curVer = this.curVer || this.$t("versionUnselected");
          this.actionAfterLaunch = config.smclActionAfterLaunch;
          this.downloadSource = config.downloadSource;
          await api.set_title(`SMCL ${VERSION} - Minecraft: ${curVer} - ${this.$t('player')}: ${playerName} - by xuanzhi33`);
        }
      },
      watch: {
        // TODO: watch
        async running(val) {
          const sleep = new Promise(resolve => setTimeout(resolve, 1000));
          if (val) {
            await sleep;
            if (this.actionAfterLaunch === "close") {
              api.close();
            } else if (this.actionAfterLaunch === "minimize") {
              api.minimize();
            }
          }
        }
      },
      async mounted() {
        await this.init_api();
        await api.init_cmcl();
        await this.init();
        this.ui = "main";
      },
      template: "#main"
    });

    app.use(i18n);
    app.mount("#app");
  </script>
</body>

</html>